(function(d){if(!d.Backbone)throw"Please include Backbone.js before Backbone.CollectionElementBinder.js";if(!d.Backbone.ModelBinder)throw"Please include Backbone.ModelBinder.js before Backbone.CollectionElementBinder.js";var g=d.Backbone,f=d._,e=d.jQuery||d.Zepto||d.ender;if(!e)throw"Please include jQuery, Zepto, Ender before Backbone.CollectionElementBinder.js";g.CollectionElementBinder=function(){};g.CollectionElementBinder.VERSION="0.1.0";f.extend(g.CollectionElementBinder.prototype,g.Events,{_collection:null,
_listEl:null,_modelPrototypeEl:null,_modelBindings:null,_onlyResetBind:!1,_modelBinders:null,_modelHtmlElements:null,bind:function(a,b,c,h,d){this.unbind();this._modelHtmlElements=[];this._modelBinders=[];this._collection=a;this._listEl=e(b);this._modelPrototypeEl=e(c);this._modelBindings=h;this._onlyResetBind=d;if(!this._collection)throw"Collection must be specified";if(f.isEmpty(this._listEl))throw"List HTML element must be specified";if(1<this._listEl.length)throw"Invalid list HTML element. Element count: "+
this._listEl.length;if(f.isEmpty(this._modelPrototypeEl))throw"Model HTML prototype must be specified";if(1<this._modelPrototypeEl.length)throw"Invalid model HTML prototype. Element count: "+this._modelPrototypeEl.length;if(f.isEmpty(this._modelBindings))throw"Model bindings must be specified";e(this._modelPrototypeEl).hide();this._bindCollectionToView()},_bindCollectionToView:function(){this._collection.on("reset",this._onCollectionReset,this);this._onlyResetBind||(this._collection.on("add",this._onCollectionAdd,
this),this._collection.on("remove",this._onCollectionRemove,this));this._onCollectionReset()},unbind:function(){this._unbindCollectionToView();this._modelBindings=this._listEl=this._collection=null;this._onlyResetBind=!1;this._modelHtmlElements=this._modelBinders=null},_unbindCollectionToView:function(){this._collection&&(this._collection.off("reset",this._onCollectionReset,this),this._collection.off("add",this._onCollectionAdd,this),this._collection.off("remove",this._onCollectionRemove,this),this._collection=
void 0);this._hideModelHtmlElement(this._modelHtmlElements);e(this._modelHtmlElements).remove()},_onCollectionReset:function(){0==this._collection.length&&this._unbindAllModels();this._collection.each(function(a,b){this._bindModel(a,b)},this);for(var a=this._modelBinders.length,b=this._collection.length;b<a;b++)this._unbindModel(b,!0);this.trigger("reset",this._collection.models)},_onCollectionAdd:function(a,b,c){this._bindModel(a,c.index);this.trigger("add",a)},_onCollectionRemove:function(a,b,c){this._unbindModel(c.index);
this.trigger("remove",a)},_bindModel:function(a,b){var c=this._getModelHtmlElement(b);this._getModelBinder(b).bind(a,c,this._modelBindings);this._showModelHtmlElement(c)},_unbindModel:function(a,b){this._getModelBinder(a).unbind();var c=this._getModelHtmlElement(a);this._hideModelHtmlElement(c);b||(e(c).detach().appendTo(this._listEl),this._recalcElementIndexes(a))},_recalcElementIndexes:function(a){a=a||0;this._modelHtmlElements=this._getAppendedModelHtmlElements();var b=a;f.each(this._modelHtmlElements,
function(c){parseInt(e(c).attr("data-ceb-index"))<a||(e(c).attr("data-ceb-index",b),b++)})},_getAppendedModelHtmlElements:function(){return this._listEl.children().not(this._modelPrototypeEl).toArray()},_unbindAllModels:function(){f.each(this._modelBinders,function(a,b){this._unbindModel(b)},this)},_getModelBinder:function(a){this._modelBinders[a]||(this._modelBinders[a]=new g.ModelBinder);return this._modelBinders[a]},_getModelHtmlElement:function(a){if(!this._modelHtmlElements[a]){var b=this._getAppendedModelHtmlElements(),
c=e(this._modelPrototypeEl).clone();c.attr("data-ceb-index",a);b=e(b).filter("[data-ceb-index="+(a-1)+"]");b.length?b.after(c):this._listEl.append(c);this._modelHtmlElements[a]=c.get(0)}return this._modelHtmlElements[a]},_showModelHtmlElement:function(a){e(a).show()},_hideModelHtmlElement:function(a){e(a).hide()},_sortByIndex:function(a){var b=a.slice();f.each(a,function(a,d){if(e(b[d]).attr("data-ceb-index")<e(b[d-1]).attr("data-ceb-index")){var f=b[d];b[d]=b[d-1];b[d-1]=f}});return b},getModelHtmlElement:function(a){a=
this._collection.indexOf(a);if(-1==a)throw"Model is not in the collection";return this._modelHtmlElements[a]}})})(this);
